<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8"/>
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- Bootstrap CSS -->
    <link
            rel="stylesheet"
            href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
            integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
            crossorigin="anonymous"
    />
    <link href="{{ url_for('static', filename='index.css') }}" rel="stylesheet">

    <!-- JS -->
    <script
            src="https://code.jquery.com/jquery-3.6.0.js"
            integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>

    <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"
    ></script>

    <!-- êµ¬ê¸€í°íŠ¸ -->
    <link
            href="https://fonts.googleapis.com/css?family=Hahmlet:wght@900&Stylish&display=swap"
            rel="stylesheet"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.4/pagination.min.js"></script>
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.4/pagination.css"
    />

    <title>ì¬íŒí•˜ëŠ” ì¡´ê²½ì¥ë‹˜</title>

</head>

<body>

<div class="container">
    <div class="sign">
        <button onclick="window.location.replace('/login_main')" type="button"
                class="btn btn-secondary loginBtn">ë¡œê·¸ì¸
        </button>
        <div class="username">ì–´ì„œì˜¤ì„¸ìš”, {{ id }} ì¡´ê²½ì¥ë‹˜
            <button class="logoutBtn btn-sm btn-outline-secondary" type="button" onclick="logout()">Logout</button>
        </div>
    </div>
    <div class="title">ì¬íŒí•˜ëŠ” ì¡´ê²½ì¥ë‹˜</div>
    <div class="buttons">
        <button
                type="button"
                class="btn btn-light btn-lg btn-block"
                id="getJudge"
                style="border: 1px solid black"
        >
            ì¬íŒë°›ê¸°ğŸ’¦
        </button>
        <button
                type="button"
                class="btn btn-dark btn-lg btn-block"
                id="doJudge"
                style="margin-top: 0px"
        >
            ì¬íŒí•˜ê¸°âš–ï¸
        </button>
    </div>
    <!-- ì¬íŒí•˜ê¸° ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ -->
    <div class="list-all">
        <div class="newList">
            <!-- <h3>ì¬íŒ ì¤‘</h3> -->
            <ul class="list-group">
                <div id="pagination"></div>
                <div id="demo"></div>
            </ul>
        </div>
        <div class="bests">
            <button
                    type="button"
                    class="btn btn-light btn-lg btn-block"
                    style="border: 1px solid black"
            >
                ì˜¤ëŠ˜ì˜ ê²©ë¡ ğŸ’¢
            </button>
            <button
                    type="button"
                    class="btn btn-primary btn-lg btn-block"
                    style="margin-top: 0px; border: 1px solid black"
            >
                ì´ë²ˆ ì£¼ì˜ ê²©ë¡ ğŸ’¥
            </button>
        </div>
        <div class="lists">
            <ul class="list-group" id="todayJudge">

            </ul>
            <ul class="list-group" id="weeklyJudge">

            </ul>
        </div>
    </div>
    <!-- ì¬íŒë°›ê¸° ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ -->
    <div class="post-container">
        <div class="inputs">
            <input class="input-title" placeholder="ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"/>
            <textarea
                    class="input-content"
                    placeholder="ê³ ë¯¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"
            ></textarea>
        </div>
        <button style="float: right; margin-bottom: 50px" onclick="post()">ì¬íŒ ì ‘ìˆ˜</button>
    </div>
</div>

<script>
    let postList = null;
    const userId = '{{ id }}';
    const date = new Date().getDate().toString();
    const month = () => {
        let getMonth = (new Date().getMonth() + 1).toString();
        if (getMonth < 10) {
            getMonth = 0 + getMonth;
        }
        return getMonth;
    }
    const year = new Date().getFullYear().toString()
    console.log(date, month(), year)

    //ë¡œê·¸ì¸ í–ˆì„ ê²½ìš°
    if (userId) {
        $('.loginBtn').hide()
        $('.username').show()
        $('.logoutBtn').show()
    }

    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
        $.removeCookie('mytoken', {path: '/'});
        window.location.href = "/"
    }

    //ì¬íŒí•˜ê¸°
    $("#doJudge").click(function () {
        $(".list-all").show();
        $(".post-container").hide();
    });

    // ì¬íŒì ‘ìˆ˜
    function post() {
        if (!userId) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!")
            return;
        }
        let title = $(".input-title").val()
        let comment = $(".input-content").val()

        if (!title.trim()) {
            alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!')
            return;
        }
        if (!comment.trim()) {
            alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!')
            return;
        }

        $.ajax({
            type: "POST",
            url: "/post",
            data: {
                title: title,
                content: comment,
                image: ''
            },
            success: function (response) {
                window.location.reload()
            }
        })
    }

    // ì¬íŒë°›ê¸°
    $("#getJudge").click(function () {
        console.log(userId);
        if (!userId) {
            alert("ì¬íŒì„ ë°›ê¸°ì „ì— ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”!")
            console.log('ì‹¤í–‰')
            return;
        }
        $(".list-all").hide();
        $(".post-container").show();
    });

    // ì¡°íšŒìˆ˜ ëŠ˜ë¦¬ê¸°
    function onClickPost() {
        console.log('hi')
    }


    // ê¸€ ëª©ë¡ ë°›ì•„ì˜¤ê¸°
    function getPosts() {

        $("#post-box").empty()
        $.ajax({
            type: "GET",
            url: `/posts`,
            data: {},
            success: function (response) {
                postList = response['posts'];
                console.log(postList)
                console.log(postList[0].postDate)
                console.log(typeof (postList[0].postDate))
                // í˜ì´ì§€ë„¤ì´ì…˜
                $("#demo").pagination({
                    pageSize: "7",
                    dataSource: postList.reverse(),
                    callback: function (data, pagination) {
                        let dataHtml = "<div onclick='onClickPost()'>";

                        $.each(data, function (index, item) {
                            dataHtml +=
                                `<a href="/post?post_id=${item['_id']}">
                                    <li
                                      class="
                                        list-group-item
                                        d-flex
                                        justify-content-between
                                        align-items-center
                                      "
                                    >` +
                                `${item["title"]}` +
                                `<span class="badge badge-primary badge-pill">${item["like"]}</span>
                                </li>
                            </a>`;
                        });

                        dataHtml += "</div>";

                        $("#pagination").html(dataHtml);
                    },
                });

                // ì˜¤ëŠ˜ì˜ ê²©ë¡ 
                let result = postList[0].postDate.split(' ', 1)[0].split('-')
                const todayPosts = postList.filter(v => v.postDate.split(' ', 1)[0].split('-')[2] === date && v.postDate.split(' ', 1)[0].split('-')[1] === month() && v.postDate.split(' ', 1)[0].split('-')[0] === year);
                todayPosts.sort((a, b) => b.like - a.like )
                console.log(todayPosts)
                console.log(result)

                let todayData = "<div onclick='onClickPost()'>";

                for (let i = 0; i < todayPosts.length; i++) {
                    todayData +=
                        `<a href="/post?post_id=${todayPosts[i]['_id']}">
                                    <li
                                      class="
                                        list-group-item
                                        d-flex
                                        justify-content-between
                                        align-items-center
                                      "
                                    >` +
                        `${todayPosts[i]["title"]}` +
                        `<span class="badge badge-primary badge-pill">${todayPosts[i]["like"]}</span>
                                </li>
                            </a>`;
                }


                todayData += "</div>";
                $("#todayJudge").append(todayData)

                // ì´ë²ˆ ì£¼ êµ¬í•˜ê¸°
                function formatDate(date) {
                    var mymonth = date.getMonth() + 1;
                    var myweekday = date.getDate();
                    return (mymonth + "/" + myweekday);
                }

                function printWeek() {
                    var now = new Date();
                    var nowDayOfWeek = now.getDay();
                    var nowDay = now.getDate();
                    var nowMonth = now.getMonth();
                    var nowYear = now.getYear();
                    nowYear += (nowYear < 2000) ? 1900 : 0;
                    var weekStartDate = new Date(nowYear, nowMonth, nowDay - nowDayOfWeek);
                    var weekEndDate = new Date(nowYear, nowMonth, nowDay + (6 - nowDayOfWeek));
                    console.log("ì´ë²ˆì£¼ëŠ” :  " + formatDate(weekStartDate) + " - " + formatDate(weekEndDate));
                }

                printWeek()


                // ì´ë²ˆ ì£¼ì˜ ê²©ë¡ 
            }
        })
    }

    getPosts();


</script>
</body>
</html>
