<!DOCTYPE html>
<html lang="ko">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8"/>
    <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
    />

    <!-- kakaotalk meta tag -->
    <meta property="og:url" content="http://starandnight.shop">
    <meta property="og:image" content="https://user-images.githubusercontent.com/84619866/133743855-03d1d3cd-b89c-409a-92fe-9aeb455c75a5.png">
    <meta property="og:description" content="ë„ˆì˜ ê³ ë¯¼, ìš°ë¦¬ê°€ ì¬íŒí•´ì£¼ì§€!">
    <meta property="og:type" content="website">
    <meta property="og:title" content="ì¬íŒí•˜ëŠ” ì¡´ê²½ì¥ë‹˜">

    <!-- Bootstrap CSS -->
    <link
            rel="stylesheet"
            href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
            integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm"
            crossorigin="anonymous"
    />
    <link href="{{ url_for('static', filename='index.css') }}" rel="stylesheet">

    <!-- JS -->
    <script
            src="https://code.jquery.com/jquery-3.6.0.js"
            integrity="sha256-H+K7U5CnXl1h5ywQfKtSj8PCmoN9aaq30gDh27Xc0jk="
            crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery-cookie/1.4.1/jquery.cookie.js"></script>

    <script
            src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
            integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
            crossorigin="anonymous"
    ></script>

    <!-- êµ¬ê¸€í°íŠ¸ -->
    <link
            href="https://fonts.googleapis.com/css?family=Hahmlet:wght@900&Stylish&display=swap"
            rel="stylesheet"
    />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.4/pagination.min.js"></script>
    <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/paginationjs/2.1.4/pagination.css"
    />

    <title>ì¬íŒí•˜ëŠ” ì¡´ê²½ì¥ë‹˜</title>

</head>

<body>
<div class="background">
    <div class="sign">
        <div class="logo">
            <img src="../static/title_white.png">
        </div>

        <button onclick="window.location.replace('/login_main')" type="button"
                class="btn btn-secondary loginBtn">ë¡œê·¸ì¸
        </button>

        <div class="username">ì–´ì„œì˜¤ì„¸ìš”, {{ id }} ì¡´ê²½ì¥ë‹˜
            <div class="navBtns">
                <button class="logoutBtn btn btn-outline-light" type="button"
                        onclick="window.location.href = '/mypage'">
                    ë§ˆì´í˜ì´ì§€
                </button>
                <button class="logoutBtn btn btn-outline-light" type="button" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>
    </div>
    <div class="container">
        <div class="title">ì¬íŒì‹¤</div>
        <div class="buttons">
            <button
                    type="button"
                    class="btn btn-light btn-lg btn-block"
                    id="getJudge"
                    style="border: 1px solid black"
            >
                ì¬íŒë°›ê¸°ğŸ’¦
            </button>
            <button
                    type="button"
                    class="btn btn-dark btn-lg btn-block"
                    id="doJudge"
                    style="margin-top: 0px"
            >
                ì¬íŒí•˜ê¸°âš–ï¸
            </button>
        </div>
        <!-- ì¬íŒí•˜ê¸° ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ -->
        <div class="list-all">
            <div class="newList">
                <!-- <h3>ì¬íŒ ì¤‘</h3> -->
                <ul class="list-group">
                    <div id="pagination"></div>
                    <div id="demo"></div>
                </ul>
            </div>
            <div class="bests">
                <div class="todayList">
                    <button
                            type="button"
                            class="btn btn-light btn btn-block"
                            style="border: 1px solid black; cursor: default"
                    >
                        ì˜¤ëŠ˜ì˜ TOP3ğŸ’¢
                    </button>
                    <ul class="list-group" id="todayJudge">

                    </ul>
                </div>
                <div class="weeklyList">
                    <button
                            type="button"
                            class="btn btn-primary btn btn-block"
                            style="margin-top: 0px; border: 1px solid black; cursor: default"
                    >
                        ì´ë²ˆ ì£¼ TOP3ğŸ’¥
                    </button>
                    <ul class="list-group" id="weeklyJudge">

                    </ul>

                </div>
            </div>

        </div>
        <!-- ì¬íŒë°›ê¸° ë¦¬ìŠ¤íŠ¸ ì¶œë ¥ -->
        <div class="post-container">
            <div class="inputs">
                <input class="input-title" placeholder="ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" maxlength='50' ; type="text"/>
                <textarea
                        maxlength="3000"
                        class="input-content"
                        placeholder="ê³ ë¯¼ ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”"
                ></textarea>
            </div>
            <button type="button" class="onclickJudgeBtn btn btn-secondary btn-lg" onclick="post()">ì¬íŒ ì ‘ìˆ˜</button>
        </div>
    </div>
</div>
<script>
    let postList = null;
    const userId = '{{ id }}';
    const date = new Date().getDate().toString();
    const month = () => {
        let getMonth = (new Date().getMonth() + 1).toString();
        if (getMonth < 10) {
            getMonth = 0 + getMonth;
        }
        return getMonth;
    }
    const year = new Date().getFullYear().toString()
    let weekStartDate;
    let weekEndDate;

    //ë¡œê·¸ì¸ í–ˆì„ ê²½ìš°
    if (userId) {
        $('.loginBtn').hide()
        $('.username').css('display', 'flex');
        $('.logoutBtn').css('display', 'flex');
    }

    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
        $.removeCookie('mytoken', {path: '/'});
        window.location.href = "/"
    }

    //ì¬íŒí•˜ê¸°
    $("#doJudge").click(function () {
        $(".list-all").show();
        $(".post-container").hide();
    });

    // ì¬íŒì ‘ìˆ˜
    function post() {
        if (!userId) {
            alert("ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤!")
            return;
        }
        let title = $(".input-title").val()
        let comment = $(".input-content").val()

        if (!title.trim()) {
            alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!')
            return;
        }
        if (!comment.trim()) {
            alert('ë‚´ìš©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!')
            return;
        }

        $.ajax({
            type: "POST",
            url: "/post",
            data: {
                title: title,
                content: comment,
                image: ''
            },
            success: function (response) {
                window.location.reload()
            }
        })
    }

    // ì¬íŒë°›ê¸°
    $("#getJudge").click(function () {
        if (!userId) {
            alert("ì¬íŒì„ ë°›ê¸°ì „ì— ë¡œê·¸ì¸ì„ í•´ì£¼ì„¸ìš”!")
            return;
        }
        $(".list-all").hide();
        $(".post-container").show();
    });


    // ë‚ ì§œ ë°ì´í„° ë³€í™˜
    function formatMonth(date) {
        const mymonth = date.getMonth() + 1;
        return mymonth;
    }

    function formatDate(date) {
        const myweekday = date.getDate();
        return myweekday;
    }


    // ê¸€ ëª©ë¡ ë°›ì•„ì˜¤ê¸°
    function getPosts() {
        {#$("#post-box").empty()#}
        $.ajax({
            type: "GET",
            url: `/posts`,
            async: false,
            data: {},
            success: function (response) {
                postList = response['posts'];
                {#alert('ì½ê¸°ë')#}
                printPosts();
            }
        })

    }

    //ìµœì‹ ëª©ë¡ ì¶œë ¥
    function printPosts() {
        $("#demo").pagination({
            pageSize: "7",
            dataSource: postList.reverse(),
            callback: function (data, pagination) {
                let allListData = ``;
                if ($("#pagination").length) {
                    $("#pagination").text('');
                }
                for (let i = 0; i < data.length; i++) {
                    (function (data) {
                        allListData =
                            $(`<div class="clickPost">
                                            <li
                                              class="
                                                list-group-item
                                                d-flex
                                                justify-content-between
                                                align-items-center
                                              "
                                            >` +
                                ` <p id="allListText">${data["title"]}</p>` +
                                `<span class="badge badge-primary badge-pill">${data["like"]}</span>
                                        </li>
                                </div>`);

                        allListData.unbind("click")
                        allListData.bind("click", function () {
                            onClickPost(data['_id'])
                        })

                        $("#pagination").append(allListData);
                        allListData = '';
                    })(data[i])

                }

            },
        });

        // ì˜¤ëŠ˜ì˜ top3
        const todayPosts = postList.filter(v => v.postDate.split(' ', 1)[0].split('-')[2] === date && v.postDate.split(' ', 1)[0].split('-')[1] === month() && v.postDate.split(' ', 1)[0].split('-')[0] === year);
        todayPosts.sort((a, b) => b.like - a.like)
        let todayData = '';

        for (let i = 0; i < todayPosts.length; i++) {
            if (i > 2) break;
            (function (data) {
                var dataHtml = '';
                dataHtml =
                    $(`<div class="clickPost">
                                    <li
                                      class="
                                        list-group-item
                                        d-flex
                                        justify-content-between
                                        align-items-center
                                      "
                                    >` +
                        ` <p id="allListText">${data["title"]}</p>` +
                        `<span class="badge badge-primary badge-pill">${data["like"]}</span>
                                </li>
                        </div>`);

                dataHtml.unbind("click")
                dataHtml.bind("click", function () {
                    onClickPost(data['_id'])
                })

                $("#todayJudge").append(dataHtml);
                dataHtml = '';
            })(todayPosts[i])
        }


        // ì´ë²ˆ ì£¼ ë‚ ì§œ êµ¬í•˜ê¸°
        let weekStartDay = 0;
        let weekLastDay = 0;

        function printWeek() {
            const now = new Date();
            const nowDayOfWeek = now.getDay();
            const nowDay = 1;
            const nowMonth = now.getMonth();
            let nowYear = now.getYear();
            nowYear += (nowYear < 2000) ? 1900 : 0;
            weekStartDate = new Date(nowYear, nowMonth, nowDay - nowDayOfWeek);
            weekEndDate = new Date(nowYear, nowMonth, nowDay + (6 - nowDayOfWeek));
            weekStartDay = formatDate(weekStartDate)
            weekLastDay = formatDate(weekEndDate)

        }

        printWeek()

        // ì´ë²ˆ ì£¼ì˜ top3
        const weeklyPosts = postList.filter(v => {
            if (weekStartDay > weekLastDay) {
                if (v.postDate.split(' ', 1)[0].split('-')[2] > toString(weekStartDay)) {
                    return true;
                }
                if (v.postDate.split(' ', 1)[0].split('-')[2] < toString(weekLastDay)) {
                    return true;
                }
                return false;
            }
            if (toString(weekStartDay) < v.postDate.split(' ', 1)[0].split('-')[2] < toString(weekLastDay)) {
                return true;
            }
            return false;
        });
        weeklyPosts.sort((a, b) => b.like - a.like)

        for (let i = 0; i < weeklyPosts.length; i++) {
            if (i > 2) break;
            (function (data) {
                var dataHtml = '';
                dataHtml =
                    $(`<div class="clickPost">
                                    <li
                                      class="
                                        list-group-item
                                        d-flex
                                        justify-content-between
                                        align-items-center
                                      "
                                    >` +
                        ` <p id="allListText">${data["title"]}</p>` +
                        `<span class="badge badge-primary badge-pill">${data["like"]}</span>
                                </li>
                        </div>`);

                dataHtml.unbind("click")
                dataHtml.bind("click", function () {
                    onClickPost(data['_id'])
                })

                $("#weeklyJudge").append(dataHtml);
                dataHtml = '';
            })(weeklyPosts[i])
        }
    }


    // ì¡°íšŒìˆ˜ ëŠ˜ë¦¬ê¸°
    function onClickPost(id) {

        $.ajax({
            type: 'POST',
            url: '/view',
            async: false,
            data:
                {
                    post_id: id
                },
            success: function (response) {
                window.location.href = `/post?post_id=${id}`
            }
        })
    }

    getPosts();


</script>
</body>
</html>
